# A Proof of Concept demonstrating the ability to drain KyberSwap Elastic pools

## Introduction

This repo contains the details of an exploit that drains 82.37% of the Elastic pool for wstETH-ETH on the Ethereum Mainnet at block height 17050000 (2023-Apr-15 04:13:47 AM +UTC).

The exploit is generalisable to any pool running on the old Elastic code in the [ks-elastic-sc-legacy](https://github.com/KyberNetwork/ks-elastic-sc-legacy) repo.

I submitted this Proof of Concept to Kyber Network on 17 April 2023. Kyber Network quickly disabled minting of new positions, and asked their LPs to withdraw their liquidity. After swiftly fixing the code and performing a fresh [audit with Chain Security](https://chainsecurity.com/security-audit/kyberswap-elastic/) Kyber Network re-launched the Elastic pools on 24 April 2023.

You can read more about the exploit in my blog post [Saving $100M at risk in KyberSwap Elastic](https://100proof.org/kyberswap-post-mortem.html).

## Details

1. The report for this exploit is in [REPORT.md](./REPORT.md)
2. The test file that performs the exploit is in [test/KyberswapTest.sol](./test/KyberswapTest.sol). The details are in function `performFullHack` at [KyberswapTest.sol:133-236](https://github.com/one-hundred-proof/kyberswap-exploit/blob/8d1bc52b040d6bdab44813835d4b7cf33571f1f2/test/KyberswapTest.sol#L133-L236)

## Setup

### Environment Variables

0. Install Foundry

Follow the [installation instructions](https://book.getfoundry.sh/getting-started/installation)

1.
Set `EVMNET_FORK_URL`

e.g.

```
export EVMNET_FORK_URL="https://mainnet.infura.io/v3/deadbeefdeadbeefdeadbeefdeadbeef"
```

Or you can add an entry in a `.env` file e.g.

```
EVMNET_FORK_URL="https://mainnet.infura.io/v3/deadbeefdeadbeefdeadbeefdeadbeef"
```

2.

```
$ npm install
```

### Run PoC

```
$ ./run-forge
```